# API Reference

## Gate.run(spec)

Run a gate. Returns a result with status, logs, and evidence.

- `spec.name` is optional metadata
- `spec.observe` defines how logs are collected
- `spec.act` triggers behavior
- `spec.assert` verifies evidence
- `spec.stop` defines `idleMs` and `maxMs`

## Actions

```ts
Act.exec("command")              // Run shell command
Act.browser({ url, headless? })  // Browser automation (playwright)
Act.wait(ms)                     // Sleep
Act.deploy({ worker })           // Deploy marker
```

## Assertions

```ts
Assert.noErrors()
Assert.hasAction("name")
Assert.hasStage("stage")
Assert.custom("name", (logs) => boolean)
```

## Shorthands (optional)

> Contributed by @grok

Flat helpers that reduce boilerplate. Import from `gateproof/shorthands`:

```ts
import { gate, commandGate, browserGate } from "gateproof/shorthands";

await gate("my-gate", { act: execAct.run("npm test"), assert: noErrors() });
await commandGate("build", "npm run build");
await browserGate("home", "https://example.com", { assert: hasAction("loaded") });
```

See full guide: `docs/how-to/use-shorthands.md`

## Result

```ts
{
  status: "success" | "failed" | "timeout",
  durationMs: number,
  logs: Log[],
  evidence: {
    requestIds: string[],
    stagesSeen: string[],
    actionsSeen: string[],
    errorTags: string[]
  },
  error?: Error
}
```

## JSON Schemas for AI Agents

> Contributed by @grok

Gate results and PRD reports are fully JSON-serializable for machine consumption. Use these schemas to parse gate outputs in agent pipelines.

### GateResultV1

```json
{
  "version": "1",
  "status": "success | failed | timeout",
  "durationMs": 1234,
  "logs": [],
  "evidence": {
    "requestIds": ["req-abc"],
    "stagesSeen": ["worker", "db"],
    "actionsSeen": ["user_created"],
    "errorTags": []
  },
  "error": {
    "tag": "AssertionFailed",
    "name": "AssertionFailed",
    "message": "HasAction: missing 'user_created'",
    "stack": "..."
  }
}
```

### PrdReportV1

```json
{
  "version": "1",
  "success": false,
  "stories": [
    {
      "id": "user-signup",
      "title": "User can sign up",
      "gateFile": "./gates/signup.gate.ts",
      "status": "failed",
      "durationMs": 5432,
      "error": { "tag": "AssertionFailed", "name": "AssertionFailed", "message": "..." }
    }
  ],
  "failedStory": {
    "id": "user-signup",
    "title": "User can sign up",
    "gateFile": "./gates/signup.gate.ts"
  },
  "totalDurationMs": 5432
}
```

### LLMFailureSummary

Structured failure context optimized for AI agents. Generated by `createLLMFailureSummary()` from `gateproof/report`:

```json
{
  "summary": "Gate \"user-signup\" failed: HasAction: missing 'user_created'",
  "failedAssertions": [
    {
      "name": "HasAction",
      "message": "missing 'user_created'",
      "expected": "user_created in logs",
      "actual": "not found"
    }
  ],
  "prdRelevantSlice": {
    "storyId": "user-signup",
    "storyTitle": "User can sign up",
    "gateFile": "./gates/signup.gate.ts",
    "scope": { "allowedPaths": ["src/routes/**"] }
  },
  "evidence": {
    "actionsSeen": ["page_load"],
    "stagesSeen": ["worker"],
    "errorTags": [],
    "logCount": 12
  },
  "diffSnippet": "diff --git a/src/routes/signup.ts ...",
  "suggestions": [
    "Ensure the code logs an action named 'user_created'",
    "Check if the relevant code path is being executed"
  ]
}
```

Usage in agent code:

```ts
import { createLLMFailureSummary } from "gateproof/report";

const summary = createLLMFailureSummary(prdReport, {
  prdSlice: { storyId: "user-signup", storyTitle: "...", gateFile: "..." },
  diffSnippet: recentGitDiff,
  logs: gateResult.logs,
});

// Feed to your agent as structured JSON
const agentPrompt = JSON.stringify(summary, null, 2);
```
